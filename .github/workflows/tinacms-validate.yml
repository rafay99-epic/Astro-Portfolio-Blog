name: Validate and Fix TinaCMS Commits

on:
  push:
    branches: ["main"]
    paths:
      - "src/content/**"
      - "tina/**"
  workflow_dispatch: {}

jobs:
  validate-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # Only run if the commit is from TinaCMS bot and not from our own fixes
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.head_commit != null && 
       github.event.head_commit.author.name != 'GitHub Actions Bot' &&
       (github.event.head_commit.author.name == 'tina-cloud-app[bot]' ||
        github.event.head_commit.author.name == 'TinaCMS' ||
        contains(github.event.head_commit.message, 'TinaCMS') ||
        contains(github.event.head_commit.message, 'Update from TinaCMS')) &&
       !contains(github.event.head_commit.message, '[skip ci]') &&
       !contains(github.event.head_commit.message, 'auto-fix formatting'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Auto-fix Prettier formatting
        run: bunx prettier --write .

      - name: Check Prettier formatting
        run: bunx prettier --check . || (echo "Prettier check failed after auto-fix" && exit 1)

      - name: TypeScript type checking
        run: bunx tsc --noEmit --skipLibCheck || (echo "TypeScript check failed" && exit 1)

      - name: Validate JSON files
        run: |
          # Validate featureFlag.json
          node -e "try { JSON.parse(require('fs').readFileSync('src/config/featureFlag/featureFlag.json', 'utf8')); console.log('✓ featureFlag.json is valid'); } catch(e) { console.error('✗ featureFlag.json is invalid:', e.message); process.exit(1); }"

          # Validate info.json if it exists
          if [ -f "src/config/siteConfig/info.json" ]; then
            node -e "try { JSON.parse(require('fs').readFileSync('src/config/siteConfig/info.json', 'utf8')); console.log('✓ info.json is valid'); } catch(e) { console.error('✗ info.json is invalid:', e.message); process.exit(1); }"
          fi

      - name: Build Astro project
        run: bun run build || (echo "Build failed" && exit 1)

      - name: Check for formatting/validation changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "No formatting or validation fixes needed."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Formatting or validation fixes applied."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git user
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git fetch origin main

      - name: Commit and push fixes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add -A

          # Check if there are actually changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "chore: auto-fix formatting and validate TinaCMS changes" -m "- Auto-fixed Prettier formatting" -m "- TypeScript type checking passed" -m "- JSON validation passed" -m "- Build successful" -m "[skip ci]"
            echo "Committed formatting and validation fixes"
            
            # Push the changes
            git push origin main
            echo "Pushed formatting and validation fixes"
          else
            echo "No changes to commit after fixes"
          fi

      - name: Validation summary
        if: always()
        run: |
          echo "## ✅ TinaCMS Commit Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Prettier formatting: Fixed and validated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript: Type checking passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ JSON: All files validated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build: Project builds successfully" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- ✅ Auto-fixes: Applied and committed" >> $GITHUB_STEP_SUMMARY
          fi
