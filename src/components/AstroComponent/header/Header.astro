---
import NavLink from "@astro/header/NavLink.astro";
import { featureFlags } from "@config/featureFlag/featureFlag.json";
import authorConfig from "@config/siteConfig/info.json";
import {
  BookOpen,
  Briefcase,
  ChevronDown,
  ExternalLink,
  Globe,
  Home,
  Menu,
  Rocket,
  Search,
  Tag,
  TrendingUp,
  User,
  X,
} from "lucide-react";
---

<style is:global>
  header {
    background-color: transparent !important;
    transition: none !important;
  }

  ::view-transition-old(header),
  ::view-transition-new(header) {
    background-color: transparent !important;
    animation: none !important;
  }

  /* Floating nav bar */
  .nav-float {
    background: rgba(26, 27, 38, 0.82);
    backdrop-filter: blur(20px) saturate(1.5);
    -webkit-backdrop-filter: blur(20px) saturate(1.5);
    border: 1px solid rgba(86, 95, 137, 0.2);
    box-shadow:
      0 2px 12px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(192, 202, 245, 0.03);
    transition:
      background 0.2s ease,
      border-color 0.2s ease,
      box-shadow 0.2s ease;
  }

  .nav-float.is-scrolled {
    background: rgba(26, 27, 38, 0.94);
    border-color: rgba(86, 95, 137, 0.25);
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(192, 202, 245, 0.04);
  }

  /* Mobile menu */
  .mobile-menu-overlay {
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(100%);
  }

  .mobile-menu-overlay.is-open {
    transform: translateX(0);
  }

  .mobile-menu-backdrop {
    transition: opacity 0.25s ease;
    opacity: 0;
  }

  .mobile-menu-backdrop.is-open {
    opacity: 1;
  }

  /* More dropdown */
  .more-dropdown {
    opacity: 0;
    transform: translateY(-4px);
    transition:
      opacity 0.15s ease,
      transform 0.15s ease;
    pointer-events: none;
  }

  .more-dropdown.is-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
</style>

<header
  class="fixed left-0 right-0 top-0 z-50"
  style={{ viewTransitionName: "header" }}
>
  <div class="mx-auto max-w-5xl px-3 pt-3 sm:px-4 sm:pt-4">
    <nav
      class="nav-float relative flex h-11 items-center justify-center rounded-2xl px-4 sm:px-5"
      id="nav-float"
    >
      <!-- Site name (left side) -->
      <a href="/" class="absolute left-4 hidden text-[13px] font-medium text-[#a9b1d6] sm:left-5 lg:block">
        {authorConfig.SiteName}
      </a>

      <!-- Desktop nav links (centered) -->
      <div class="hidden items-center gap-0.5 lg:flex">
        <NavLink href="/">Home</NavLink>

        {featureFlags.showBlog && <NavLink href="/blog">Articles</NavLink>}

        {featureFlags.showAbout && <NavLink href="/about">About</NavLink>}

        {
          featureFlags.showExperience && (
            <NavLink href="/experience">Experience</NavLink>
          )
        }

        {
          featureFlags.showProjects && (
            <NavLink href="/project">Projects</NavLink>
          )
        }

        {
          (featureFlags.showTrendingPosts || featureFlags.showWiki) && (
            <div class="relative" id="more-dropdown-container">
              <button
                aria-haspopup="true"
                id="more-dropdown-button"
                class="flex h-8 items-center gap-0.5 px-3 text-[13px] text-[#565f89] transition-colors duration-150 hover:text-[#c0caf5]"
                aria-expanded="false"
              >
                More
                <ChevronDown
                  id="more-dropdown-chevron"
                  className="h-3 w-3 transition-transform duration-200"
                />
              </button>

              <div
                id="more-dropdown-menu"
                class="more-dropdown absolute right-0 z-50 mt-2 w-48 rounded-lg border border-[#565f89]/15 bg-[#1a1b26]/95 py-1 shadow-lg backdrop-blur-md"
              >
                {featureFlags.showTrendingPosts && (
                  <a
                    role="menuitem"
                    href="/trending"
                    class="flex items-center gap-2.5 px-3 py-2 text-[13px] text-[#a9b1d6] transition-colors duration-150 hover:bg-[#24283b]/50 hover:text-[#c0caf5]"
                  >
                    <TrendingUp className="w-3.5 h-3.5 text-[#565f89]" />
                    Trending
                  </a>
                )}
                {featureFlags.showWiki && (
                  <a
                    role="menuitem"
                    href="https://rafay99-docs.vercel.app/"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-2.5 px-3 py-2 text-[13px] text-[#a9b1d6] transition-colors duration-150 hover:bg-[#24283b]/50 hover:text-[#c0caf5]"
                  >
                    <Globe className="w-3.5 h-3.5 text-[#565f89]" />
                    Wiki
                    <ExternalLink className="ml-auto w-3 h-3 text-[#414868]" />
                  </a>
                )}
              </div>
            </div>
          )
        }
      </div>

      <!-- Right side: utility icons + mobile toggle -->
      <div class="absolute right-3 flex items-center gap-0.5 sm:right-4">
        {
          featureFlags.showTags && (
            <NavLink
              href="/tag"
              icon={Tag}
              aria-label="Tags"
              className="hidden lg:flex"
            />
          )
        }
        {
          featureFlags.showSearch && (
            <NavLink
              href="/search"
              icon={Search}
              aria-label="Search"
              className="hidden lg:flex"
            />
          )
        }

        <button
          aria-label="Toggle menu"
          aria-haspopup="menu"
          id="mobile-menu-button"
          aria-expanded="false"
          class="flex h-8 w-8 items-center justify-center rounded-md text-[#565f89] transition-colors duration-150 hover:text-[#a9b1d6] lg:hidden"
        >
          <Menu id="menu-icon" className="h-5 w-5" />
          <X id="close-icon" className="hidden h-5 w-5" />
        </button>
      </div>
    </nav>
  </div>
</header>

<!-- Mobile backdrop -->
<div
  id="mobile-menu-backdrop"
  class="mobile-menu-backdrop fixed inset-0 z-[90] hidden bg-black/40 backdrop-blur-sm lg:hidden"
>
</div>

<!-- Mobile slide-out menu -->
<nav
  id="mobile-menu"
  class="mobile-menu-overlay fixed right-0 top-0 z-[100] flex h-full w-72 max-w-[80vw] flex-col bg-[#1a1b26] lg:hidden"
>
  <!-- Mobile menu header -->
  <div class="flex items-center justify-between px-4 py-3.5 border-b border-[#565f89]/10">
    <a href="/" class="flex items-center gap-2.5">
      <span class="flex h-7 w-7 shrink-0 overflow-hidden rounded-full">
        <img
          src="/rafay99-avatar.jpg"
          alt={authorConfig.SiteName}
          class="h-full w-full object-cover"
        />
      </span>
      <span class="text-[13px] leading-none font-medium text-[#a9b1d6]">
        {authorConfig.SiteName}
      </span>
    </a>
    <button
      id="close-mobile-menu"
      class="rounded-md p-1.5 text-[#565f89] transition-colors duration-150 hover:text-[#a9b1d6]"
      aria-label="Close menu"
    >
      <X className="h-4 w-4" />
    </button>
  </div>

  <!-- Mobile nav links -->
  <div class="flex-1 overflow-y-auto px-3 py-3">
    <div class="space-y-0.5">
      <NavLink href="/" icon={Home} mobile>Home</NavLink>

      {
        featureFlags.showBlog && (
          <NavLink href="/blog" icon={BookOpen} mobile>
            Articles
          </NavLink>
        )
      }

      {
        featureFlags.showAbout && (
          <NavLink href="/about" icon={User} mobile>
            About
          </NavLink>
        )
      }

      {
        featureFlags.showExperience && (
          <NavLink href="/experience" icon={Briefcase} mobile>
            Experience
          </NavLink>
        )
      }

      {
        featureFlags.showProjects && (
          <NavLink href="/project" icon={Rocket} mobile>
            Projects
          </NavLink>
        )
      }

      {
        featureFlags.showTags && (
          <NavLink href="/tag" icon={Tag} mobile>
            Tags
          </NavLink>
        )
      }

      {
        featureFlags.showSearch && (
          <NavLink href="/search" icon={Search} mobile>
            Search
          </NavLink>
        )
      }
    </div>

    {
      (featureFlags.showTrendingPosts || featureFlags.showWiki) && (
        <div class="mt-4 border-t border-[#565f89]/10 pt-4">
          <p class="mb-2 px-3 text-[11px] font-medium uppercase tracking-wider text-[#414868]">
            More
          </p>
          <div class="space-y-0.5">
            {featureFlags.showTrendingPosts && (
              <NavLink href="/trending" icon={TrendingUp} mobile>
                Trending
              </NavLink>
            )}
            {featureFlags.showWiki && (
              <NavLink
                href="https://rafay99-docs.vercel.app/"
                icon={Globe}
                target="_blank"
                rel="noopener noreferrer"
                mobile
              >
                Wiki
              </NavLink>
            )}
          </div>
        </div>
      )
    }
  </div>
</nav>

<script is:inline>
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileMenuBackdrop = document.getElementById("mobile-menu-backdrop");
  const closeMobileMenuButton = document.getElementById("close-mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const navFloat = document.getElementById("nav-float");

  let isMobileMenuOpen = false;

  // Scroll state for nav background
  const updateNavScroll = () => {
    if (!navFloat) return;
    if (window.scrollY > 8) {
      navFloat.classList.add("is-scrolled");
    } else {
      navFloat.classList.remove("is-scrolled");
    }
  };
  window.addEventListener("scroll", updateNavScroll, { passive: true });
  updateNavScroll();

  const toggleMobileMenu = () => {
    isMobileMenuOpen = !isMobileMenuOpen;
    mobileMenuButton.setAttribute("aria-expanded", isMobileMenuOpen.toString());

    if (isMobileMenuOpen) {
      mobileMenu.classList.add("is-open");
      mobileMenuBackdrop.classList.add("is-open");
      mobileMenuBackdrop.classList.remove("hidden");
      menuIcon.classList.add("hidden");
      closeIcon.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    } else {
      mobileMenu.classList.remove("is-open");
      mobileMenuBackdrop.classList.remove("is-open");

      setTimeout(() => {
        mobileMenuBackdrop.classList.add("hidden");
      }, 250);
      menuIcon.classList.remove("hidden");
      closeIcon.classList.add("hidden");
      document.body.style.overflow = "";
    }
  };

  const closeMobileMenu = () => {
    if (isMobileMenuOpen) {
      toggleMobileMenu();
    }
  };

  if (mobileMenuButton) {
    mobileMenuButton.addEventListener("click", toggleMobileMenu);
  }
  if (closeMobileMenuButton) {
    closeMobileMenuButton.addEventListener("click", closeMobileMenu);
  }
  if (mobileMenuBackdrop) {
    mobileMenuBackdrop.addEventListener("click", closeMobileMenu);
  }

  window.addEventListener("popstate", closeMobileMenu);

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 1024 && isMobileMenuOpen) {
      closeMobileMenu();
    }
  });

  document.addEventListener("astro:after-swap", closeMobileMenu);

  // More dropdown
  const moreDropdownButton = document.getElementById("more-dropdown-button");
  const moreDropdownMenu = document.getElementById("more-dropdown-menu");
  const moreDropdownChevron = document.getElementById("more-dropdown-chevron");
  const moreDropdownContainer = document.getElementById(
    "more-dropdown-container",
  );

  let isMoreDropdownOpen = false;

  const toggleMoreDropdown = () => {
    isMoreDropdownOpen = !isMoreDropdownOpen;
    moreDropdownButton.setAttribute(
      "aria-expanded",
      isMoreDropdownOpen.toString(),
    );

    if (isMoreDropdownOpen) {
      moreDropdownMenu.classList.add("is-open");
      moreDropdownChevron.style.transform = "rotate(180deg)";
    } else {
      moreDropdownMenu.classList.remove("is-open");
      moreDropdownChevron.style.transform = "rotate(0deg)";
    }
  };

  const closeMoreDropdown = () => {
    if (isMoreDropdownOpen) {
      isMoreDropdownOpen = false;
      moreDropdownButton.setAttribute("aria-expanded", "false");
      moreDropdownMenu.classList.remove("is-open");
      moreDropdownChevron.style.transform = "rotate(0deg)";
    }
  };

  if (moreDropdownButton) {
    moreDropdownButton.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMoreDropdown();
    });
  }

  document.addEventListener("click", (e) => {
    if (moreDropdownContainer && !moreDropdownContainer.contains(e.target)) {
      closeMoreDropdown();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && isMoreDropdownOpen) {
      closeMoreDropdown();
    }
  });

  document.addEventListener("astro:after-swap", closeMoreDropdown);
</script>
