---
// src/pages/tag/index.astro
import { getCollection } from "astro:content";

import BaseHead from "../../components/AstroComponent/base/BaseHead.astro";
import Header from "../../components/AstroComponent/header/Header.astro";
import Footer from "../../components/AstroComponent/footer/Footer.astro";
import authorConfig from "../../config/siteConfig/info.json";
import TagFilterDisplay from "../../components/AstroComponent/blog/comments/TagFilterDisplay.astro";
import { featureFlags } from "../../config/featureFlag/featureFlag.json";
import { ViewTransitions } from "astro:transitions";

export const prerender = true;

// Get all posts, sort by publish date (descending)
const allPosts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(), // Sort descending
);

// Filter out draft posts
const publishedPosts = allPosts.filter((post) => !post.data.draft);

// Get all unique tags from published posts
const allTags = Array.from(
    new Set(publishedPosts.flatMap((post) => post.data.tags || [])),
).sort((a, b) => (a as string).localeCompare(b as string)) as string[];

// This is the "All" page - no specific tag selected
const selectedTag = null;
const currentPage = 1;

// Show all posts for the "All" page
const filteredPosts = publishedPosts;

// Pagination logic
const postsPerPage = 10;
const totalPages = Math.ceil(filteredPosts.length / postsPerPage);

const paginatedPosts = filteredPosts.slice(
    (currentPage - 1) * postsPerPage,
    currentPage * postsPerPage,
);

try {
    if (!featureFlags.showTags) {
        return Astro.redirect("/access-denied");
    }
} catch (error) {
    return Astro.redirect("/404");
}
---

<html lang="en">
    <head>
        <BaseHead
            title={`Tags | ${authorConfig.SiteName}`}
            description={`Browse all tags on ${authorConfig.SiteName} and explore categorized content.`}
        />
        <ViewTransitions />
    </head>

    <body>
        <Header />
        <main class="w-full max-w-5xl mx-auto">
            <div>
                <TagFilterDisplay
                    allTags={allTags}
                    paginatedPosts={paginatedPosts}
                    selectedTag={selectedTag}
                    currentPage={currentPage}
                    totalPages={totalPages}
                    currentUrl={new URL(Astro.url)}
                />
            </div>
        </main>
        <Footer class="mt-auto" />
    </body>
</html>
