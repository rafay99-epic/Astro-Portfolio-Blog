---
import BaseHead from "../../../components/AstroComponent/base/BaseHead.astro";
import Header from "../../../components/AstroComponent/header/Header.astro";
import Footer from "../../../components/AstroComponent/footer/Footer.astro";
import authorConfig from "../../../config/siteConfig/info.json";
import TagFilterDisplay from "../../../components/AstroComponent/blog/comments/TagFilterDisplay.astro";
import { featureFlags } from "../../../config/featureFlag/featureFlag.json";
import { ViewTransitions } from "astro:transitions";
import { getCollection } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
    if (!featureFlags.showTags) {
        return [];
    }

    const allPosts = (await getCollection("blog"))
        .filter((post) => !post.data.draft)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    // Get all unique tags
    const allTags = Array.from(
        new Set(allPosts.flatMap((post) => post.data.tags || [])),
    ).sort((a, b) => (a as string).localeCompare(b as string)) as string[];

    const paths: any[] = [];
    const postsPerPage = 10;
    const totalPages = Math.ceil(allPosts.length / postsPerPage);

    // Generate paths for each page of "All" posts
    for (let page = 2; page <= totalPages; page++) {
        paths.push({
            params: { page: page.toString() },
            props: {
                tag: null,
                page,
                totalPages,
                postsPerPage,
                allPosts,
                allTags,
            },
        });
    }

    return paths;
}

const { tag, page, totalPages, postsPerPage, allPosts, allTags } = Astro.props;
const currentPage = page;

// Get posts for current page (all posts, no tag filter)
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = allPosts.slice(startIndex, endIndex);

try {
    if (!featureFlags.showTags) {
        return Astro.redirect("/access-denied");
    }
} catch (error) {
    return Astro.redirect("/404");
}
---

<html lang="en">
    <head>
        <BaseHead
            title={`All Articles - Page ${currentPage} | ${authorConfig.SiteName}`}
            description={`Browse all articles on page ${currentPage} of ${authorConfig.SiteName}.`}
        />
        <ViewTransitions />
    </head>

    <body>
        <Header />
        <main class="w-full max-w-5xl mx-auto">
            <div>
                <TagFilterDisplay
                    allTags={allTags}
                    paginatedPosts={paginatedPosts}
                    selectedTag={tag}
                    currentPage={currentPage}
                    totalPages={totalPages}
                    currentUrl={new URL(Astro.url)}
                />
            </div>
        </main>
        <Footer class="mt-auto" />
    </body>
</html>
