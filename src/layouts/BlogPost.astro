---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseHead from "@astro/base/BaseHead.astro";
import PostComment from "@astro/blog/comments/PostComment.astro";
import Footer from "@astro/footer/Footer.astro";
import Header from "@astro/header/Header.astro";
import { featureFlags } from "@config/featureFlag/featureFlag.json";
import CodeCopySimple from "@react/blog/enhancements/code-copy/CodeCopySimple";
import MermaidRenderer from "@react/blog/enhancements/diagram-renderer/MermaidRenderer";
import EnhancedImageCaptionRenderer from "@react/blog/enhancements/image-caption-renderer/EnhancedImageCaptionRenderer";
import ShareButtons from "@react/blog/interactions/socialButton";
import BlogNavigation from "@react/blog/layout/BlogNavigation";
import { Icon } from "astro-icon/components";
import { getImagePath } from "astro-opengraph-images";
import { SEO } from "astro-seo";

export const prerender = true;

const { url, site } = Astro;
const openGraphImageUrl = getImagePath({ url, site });

const pageUrl = Astro.url.href;
type Props = CollectionEntry<"blog">["data"] & {
	isArchive?: boolean;
	headings?: import("astro").MarkdownHeading[];
};
const isArchive = (Astro.props as Props).isArchive === true;

try {
	if (!featureFlags.showBlog) {
		return Astro.redirect("/access-denied");
	}
} catch (_error) {
	return Astro.redirect("/404");
}

const BlogPosts = featureFlags.showBlog
	? (await getCollection("blog"))
			.filter(
				(post: CollectionEntry<"blog">) =>
					!post.data.draft &&
					(isArchive ? post.data.archived : !post.data.archived),
			)
			.sort(
				(a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
					a.data.pubDate.valueOf() - b.data.pubDate.valueOf(),
			)
	: [];

const currentSlug = Astro.url.pathname.split("/").filter(Boolean).pop();
const currentBlog = BlogPosts.find(
	(post: CollectionEntry<"blog">) => post.slug === currentSlug,
);

if (!currentBlog) {
	return Astro.redirect("/access-denied");
}

const currentIndex = BlogPosts.findIndex(
	(post: CollectionEntry<"blog">) => post.slug === currentSlug,
);
const prevPost = currentIndex > 0 ? BlogPosts[currentIndex - 1] : undefined;
const nextPost =
	currentIndex >= 0 && currentIndex < BlogPosts.length - 1
		? BlogPosts[currentIndex + 1]
		: undefined;

const blogContent = currentBlog.body;

const {
	title,
	description,
	pubDate,
	heroImage,
	authorName,
	authorAvatar,
	tags,
	readTime,
	keywords,
	canonicalUrl,
	featured,
	excerpt,
	headings: tocHeadings = [],
} = Astro.props as Props;
const lead = excerpt || description;
const tocEntries = tocHeadings.filter(
	(h: import("astro").MarkdownHeading) => h.depth === 2 || h.depth === 3,
);
const wordCount = blogContent
	? blogContent.trim().split(/\s+/).filter(Boolean).length
	: 0;
const formattedWordCount =
	wordCount > 0 ? new Intl.NumberFormat("en-US").format(wordCount) : "";
const markdownDate = pubDate.toISOString().slice(0, 10);
const markdownBody = blogContent?.trim() || "";
const markdownPayload = [
	`# ${title}`,
	"",
	`Source: ${pageUrl}`,
	`Published: ${markdownDate}`,
	"",
	...(lead ? [lead, ""] : []),
	"---",
	"",
	markdownBody,
	"",
].join("\n");
const postActionPayload = JSON.stringify({
	title,
	url: pageUrl,
	markdown: markdownPayload,
}).replace(/</g, "\\u003c");
---

<html lang="en">
  <head>
    <BaseHead
      title={title}
      description={description}
      image={heroImage}
      keywords={keywords}
    />

    <style>
      /* Prevent white flash - Critical styles */
      html {
        background-color: #1a1b26 !important;
      }

      body {
        background-color: #1a1b26 !important;
        transition: none !important;
      }

      .blog-container {
        background-color: #1a1b26 !important;
      }
    </style>

    <style is:inline>
      html {
        background-color: #1a1b26 !important;
      }
      body {
        background-color: #1a1b26 !important;
      }
      #__astro {
        background-color: #1a1b26 !important;
      }
    </style>

    <style>
      .blog-container .main-content {
        margin: 0;
        padding: 0;
        max-width: 100%;
      }

      .post-shell {
        position: relative;
        z-index: 1;
        width: min(92vw, 80rem);
        margin: 5rem auto 0;
        padding: 3rem 0 3.5rem;
      }

      .ads-section {
        width: min(92vw, 72ch);
        margin: 3rem auto 0;
      }

      .ads-section--rail {
        width: 100%;
        margin: 0;
      }

      .ads-slot {
        min-height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
      }

      .ads-section--rail .ads-slot {
        max-width: 100%;
        overflow: hidden;
      }

      .ads-section--rail .ads-slot .adsbygoogle {
        max-width: 100%;
      }

      .ads-section-title {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #414868;
        margin-bottom: 0.75rem;
      }

      .comments-section {
        width: min(92vw, 72ch);
        margin: 3rem auto 0;
        padding-bottom: 4rem;
      }

      .post-header {
        padding: 0 0 2.5rem;
        border-bottom: 1px solid rgba(86, 95, 137, 0.18);
      }

      .post-eyebrow {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem 1rem;
        color: #565f89;
        font-size: 0.8rem;
        letter-spacing: 0.06em;
      }

      .post-title {
        margin: 1rem 0 0.75rem;
        font-size: clamp(2.3rem, 4vw, 3.75rem);
        line-height: 1.1;
      }

      .post-lead {
        margin-top: 0.75rem;
        font-size: 1.15rem;
        line-height: 1.7;
        color: #a9b1d6;
        max-width: 60ch;
      }

      .post-byline {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        align-items: center;
        margin-top: 1.25rem;
        color: #565f89;
        font-size: 0.85rem;
      }

      .post-author {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #a9b1d6;
      }

      .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 1.25rem;
      }

      .post-tag {
        color: #565f89;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
        transition: color 0.2s ease;
      }

      .post-tag:hover {
        color: #7aa2f7;
      }

      .post-tag::before {
        content: "#";
        opacity: 0.5;
      }

      .post-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        color: #bb9af7;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
      }

      .post-badge::before {
        content: "\2022";
        opacity: 0.4;
      }

      .post-grid {
        display: grid;
        gap: 3rem;
        margin-top: 2.5rem;
      }

      .post-rail {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .post-card {
        padding: 0;
      }

      .post-card + .post-card {
        padding-top: 1.5rem;
        border-top: 1px solid rgba(86, 95, 137, 0.12);
      }

      .post-card-title {
        font-size: 0.7rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #414868;
        margin-bottom: 0.85rem;
      }

      .post-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.82rem;
        color: #565f89;
        margin-bottom: 0.5rem;
      }

      .post-stat strong {
        color: #a9b1d6;
        font-weight: 500;
      }

      .post-progress {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-top: 0.6rem;
      }

      .post-progress-track {
        flex: 1;
        height: 3px;
        background: rgba(86, 95, 137, 0.2);
        border-radius: 999px;
        overflow: hidden;
      }

      .post-progress-fill {
        height: 100%;
        background: #7aa2f7;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.1s ease-out;
      }

      .post-progress-label {
        font-size: 0.7rem;
        color: #414868;
        min-width: 2.2rem;
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .post-actions {
        display: grid;
        gap: 0.75rem;
      }

      .post-actions-share {
        margin-top: 0.25rem;
      }

      .post-action-menu {
        position: relative;
      }

      .post-action-split {
        display: flex;
        align-items: stretch;
        border-radius: 8px;
        border: 1px solid rgba(86, 95, 137, 0.2);
        overflow: hidden;
      }

      .post-action-main,
      .post-action-toggle {
        appearance: none;
        border: 0;
        background: transparent;
        color: #565f89;
        cursor: pointer;
        transition:
          color 0.15s ease,
          background-color 0.15s ease;
      }

      .post-action-main {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        flex: 1;
        padding: 0.55rem 0.75rem;
        font-size: 0.82rem;
        text-align: left;
        overflow: hidden;
      }

      .post-action-main::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          110deg,
          transparent 0%,
          rgba(122, 162, 247, 0.22) 50%,
          transparent 100%
        );
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
      }

      .post-action-main:hover,
      .post-action-toggle:hover {
        background: rgba(122, 162, 247, 0.06);
        color: #a9b1d6;
      }

      .post-action-main.is-loading::after {
        opacity: 1;
        animation: post-action-shimmer 1.2s linear infinite;
      }

      .post-action-main.is-loading {
        color: #7aa2f7;
      }

      .post-action-main.is-loading .post-action-main-icon {
        opacity: 0.55;
      }

      .post-action-main.is-loading .post-action-main-loader {
        opacity: 1;
        transform: scale(1);
        animation: post-action-spin 0.85s linear infinite;
      }

      .post-action-main.is-success {
        color: #9ece6a;
        background: rgba(158, 206, 106, 0.06);
      }

      .post-action-main.is-success .post-action-main-icon {
        color: #9ece6a;
      }

      .post-action-main-icon {
        display: inline-flex;
        width: 0.9rem;
        height: 0.9rem;
        color: #565f89;
        flex-shrink: 0;
        transition:
          color 0.15s ease,
          opacity 0.15s ease;
      }

      .post-action-main-label {
        flex: 1;
      }

      .post-action-main-loader {
        width: 0.9rem;
        height: 0.9rem;
        border-radius: 999px;
        border: 2px solid rgba(122, 162, 247, 0.25);
        border-top-color: #7aa2f7;
        opacity: 0;
        transform: scale(0.8);
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
      }

      .post-action-toggle {
        width: 2.2rem;
        border-left: 1px solid rgba(86, 95, 137, 0.15);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .post-action-chevron {
        display: inline-flex;
        font-size: 0.7rem;
        color: #414868;
        transition:
          color 0.15s ease,
          transform 0.15s ease;
      }

      .post-action-menu.is-open .post-action-chevron {
        color: #7aa2f7;
        transform: rotate(180deg);
      }

      .post-action-menu.is-open .post-action-toggle {
        background: rgba(122, 162, 247, 0.06);
      }

      .post-action-dropdown {
        position: absolute;
        top: calc(100% + 0.4rem);
        left: 0;
        right: 0;
        z-index: 12;
        display: grid;
        gap: 0.2rem;
        padding: 0.35rem;
        border-radius: 8px;
        border: 1px solid rgba(86, 95, 137, 0.2);
        background: rgba(26, 27, 38, 0.98);
        box-shadow: 0 8px 20px rgba(10, 12, 20, 0.4);
      }

      .post-action-dropdown[hidden] {
        display: none;
      }

      .post-action-option {
        position: relative;
        display: flex;
        width: 100%;
        align-items: center;
        justify-content: flex-start;
        gap: 0.45rem;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #a9b1d6;
        font-size: 0.78rem;
        padding: 0.45rem 0.55rem;
        text-align: left;
        overflow: hidden;
        cursor: pointer;
        transition:
          color 0.15s ease,
          background-color 0.15s ease;
      }

      .post-action-option::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          115deg,
          transparent 0%,
          rgba(122, 162, 247, 0.2) 50%,
          transparent 100%
        );
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
      }

      .post-action-option:hover {
        color: #7aa2f7;
        background: rgba(122, 162, 247, 0.08);
      }

      .post-action-option-icon {
        display: inline-flex;
        width: 0.95rem;
        height: 0.95rem;
        color: #7aa2f7;
        opacity: 0.92;
        flex-shrink: 0;
      }

      .post-action-option-label {
        flex: 1;
      }

      .post-action-option-loader {
        width: 0.9rem;
        height: 0.9rem;
        border-radius: 999px;
        border: 2px solid rgba(122, 162, 247, 0.25);
        border-top-color: #7aa2f7;
        opacity: 0;
        transform: scale(0.8);
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
      }

      .post-action-option.is-loading {
        background: rgba(122, 162, 247, 0.06);
      }

      .post-action-option.is-loading::after {
        opacity: 1;
        animation: post-action-shimmer 1.2s linear infinite;
      }

      .post-action-option.is-loading .post-action-option-loader {
        opacity: 1;
        transform: scale(1);
        animation: post-action-spin 0.85s linear infinite;
      }

      .post-action-option.is-loading .post-action-option-icon {
        opacity: 0.55;
      }

      .post-action-option.is-success {
        background: rgba(158, 206, 106, 0.08);
        color: #9ece6a;
      }

      .post-action-option.is-success .post-action-option-icon {
        color: #9ece6a;
      }

      .post-action-option:focus-visible,
      .post-action-main:focus-visible,
      .post-action-toggle:focus-visible {
        outline: 1px solid rgba(122, 162, 247, 0.5);
        outline-offset: 1px;
      }

      .post-action-status {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.7rem;
        color: #414868;
        min-height: 1rem;
      }

      .post-content {
        width: 100%;
        max-width: 72ch;
        margin: 0 auto;
      }

      .post-toc {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
        font-size: 0.8rem;
        max-height: 50vh;
        overflow: auto;
        padding-right: 0.25rem;
      }

      .post-toc .toc-link {
        display: block;
        color: #414868;
        text-decoration: none;
        padding: 0.25rem 0 0.25rem 0.75rem;
        border-left: 1px solid transparent;
        line-height: 1.4;
        transition:
          color 0.15s ease,
          border-color 0.15s ease;
      }

      .post-toc .toc-link:hover {
        color: #a9b1d6;
      }

      .post-toc .toc-link.is-active {
        color: #c0caf5;
        border-color: #7aa2f7;
      }

      .post-toc .toc-h3 {
        padding-left: 1.5rem;
        font-size: 0.75rem;
      }

      .post-toc-empty {
        color: #414868;
        font-size: 0.78rem;
      }

      @keyframes post-action-spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes post-action-shimmer {
        to {
          transform: translateX(120%);
        }
      }

      @keyframes post-action-success-pop {
        0% {
          transform: scale(0.98);
        }
        60% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      :global(.blog-prose) {
        font-size: 1.05rem;
        line-height: 1.85;
        color: #c0caf5;
      }

      :global(.blog-prose h2),
      :global(.blog-prose h3) {
        scroll-margin-top: 120px;
      }

      :global(.blog-prose h2) {
        margin-top: 3rem;
        font-size: 1.65rem;
        color: #c0caf5;
      }

      :global(.blog-prose h3) {
        margin-top: 2.25rem;
        font-size: 1.3rem;
        color: #a9b1d6;
      }

      :global(.blog-prose a) {
        text-decoration: underline;
        text-decoration-thickness: 2px;
        text-underline-offset: 3px;
      }

      @media (min-width: 1024px) {
        .post-grid {
          grid-template-columns: minmax(0, 16rem) minmax(0, 72ch) minmax(
              0,
              16rem
            );
          align-items: start;
        }

        .post-rail {
          position: sticky;
          top: 6.5rem;
        }

        .post-content {
          margin: 0;
        }
      }

      @media (max-width: 1023px) {
        .post-grid {
          gap: 2rem;
        }

        .post-rail--left {
          order: 2;
        }

        .post-content {
          order: 1;
        }

        .post-rail--right {
          order: 3;
        }

        .post-rail {
          flex-direction: row;
          flex-wrap: wrap;
          gap: 1.5rem;
        }

        .post-card {
          flex: 1;
          min-width: 200px;
        }

        .post-card + .post-card {
          padding-top: 0;
          border-top: none;
          padding-left: 1.5rem;
          border-left: 1px solid rgba(86, 95, 137, 0.12);
        }
      }

      @media (max-width: 768px) {
        .post-shell {
          margin-top: 3.5rem;
          padding: 2rem 0 3rem;
        }

        .post-header {
          padding: 0 0 1.75rem;
        }

        .post-title {
          font-size: clamp(1.75rem, 7vw, 2.5rem);
        }

        .post-lead {
          font-size: 1rem;
        }

        .post-rail {
          flex-direction: column;
        }

        .post-card {
          min-width: unset;
        }

        .post-card + .post-card {
          padding-left: 0;
          border-left: none;
          padding-top: 1.25rem;
          border-top: 1px solid rgba(86, 95, 137, 0.12);
        }
      }

      @media (max-width: 480px) {
        .post-shell {
          margin-top: 3rem;
          padding: 1.5rem 0 2.5rem;
        }

        .post-title {
          font-size: clamp(1.5rem, 8vw, 2rem);
        }
      }
    </style>

    <SEO
      title={title}
      description={description}
      openGraph={{
        basic: {
          title: title,
          type: "article",
          image: heroImage
            ? new URL(heroImage, Astro.url).toString()
            : openGraphImageUrl,
          url: pageUrl,
        },
        optional: {
          description: description,
          locale: "en_US",
          siteName: "Rafay99",
        },
      }}
      twitter={{
        card: "summary_large_image",
        site: "@rafay99",
        creator: "@rafay99",
      }}
    />

    <script
      is:inline
      async
      type="text/plain"
      data-category="analytics"
      data-type="text/partytown"
      src="https://www.googletagmanager.com/gtag/js?id=G-DKPL4VGM52"></script>
    <script
      is:inline
      type="text/plain"
      data-category="analytics"
      data-type="text/partytown"
    >
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-DKPL4VGM52");
    </script>

    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        headline: title,
        description: description,
        image: heroImage
          ? new URL(heroImage, Astro.url).toString()
          : new URL("/Rafay99.webp", Astro.url).toString(),
        author: {
          "@type": "Person",
          name: authorName,
          image: authorAvatar
            ? new URL(authorAvatar, Astro.url).toString()
            : new URL("/author.jpg", Astro.url).toString(),
          url: "https://rafay99.com",
        },
        publisher: {
          "@type": "Organization",
          name: "Rafay99",
          logo: {
            "@type": "ImageObject",
            url: new URL("/favicon.webp", Astro.url).toString(),
          },
        },
        datePublished: pubDate.toISOString(),
        dateModified:
          currentBlog.data.updatedDate?.toISOString() || pubDate.toISOString(),
        mainEntityOfPage: {
          "@type": "WebPage",
          "@id": pageUrl,
        },
        keywords:
          keywords?.join(", ") ||
          tags?.join(", ") ||
          "blog, technology, programming",
        articleSection: tags?.[0] || "Technology",
        wordCount: blogContent ? blogContent.length : 0,
        timeRequired: readTime || "5 min read",
      })}
    />

    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://rafay99.com",
          },
          {
            "@type": "ListItem",
            position: 2,
            name: "Blog",
            item: "https://rafay99.com/blog",
          },
          {
            "@type": "ListItem",
            position: 3,
            name: title,
            item: pageUrl,
          },
        ],
      })}
    />

    {
      (() => {
        if (!blogContent) return null;

        const faqMatches = blogContent.match(/^#{2,6}\s+(.+)$/gm);
        if (!faqMatches || faqMatches.length < 3) return null;

        const faqItems = faqMatches
          .slice(0, 5)
          .map((heading: string, _index: number) => {
            const text = heading.replace(/^#{2,6}\s+/, "");
            return {
              "@type": "Question",
              name: text,
              acceptedAnswer: {
                "@type": "Answer",
                text: `This section covers ${text.toLowerCase()}. Read the full article for detailed information.`,
              },
            };
          });

        return (
          <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify({
              "@context": "https://schema.org",
              "@type": "FAQPage",
              mainEntity: faqItems,
            })}
          />
        );
      })()
    }

    <meta name="author" content={authorName} />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="googlebot" content="index, follow" />
    <meta name="bingbot" content="index, follow" />
    <meta name="copyright" content="© 2025 Abdul Rafay" />
    <meta
      name="keywords"
      content={keywords?.join(", ") ||
        tags?.join(", ") ||
        "blog, technology, programming"}
    />
    <meta name="article:published_time" content={pubDate.toISOString()} />
    {
      currentBlog.data.updatedDate && (
        <meta
          name="article:modified_time"
          content={currentBlog.data.updatedDate.toISOString()}
        />
      )
    }
    <meta name="article:author" content={authorName} />
    {tags?.map((tag: string) => <meta name="article:tag" content={tag} />)}
    <meta name="article:section" content={tags?.[0] || "Technology"} />
    {featured && <meta name="article:featured" content="true" />}
    {excerpt && <meta name="description" content={excerpt} />}

    <meta name="revisit-after" content="7 days" />
    <meta name="rating" content="general" />
    <meta name="distribution" content="global" />
    <meta name="coverage" content="worldwide" />
    <meta name="target" content="all" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="format-detection" content="telephone=no" />

    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Rafay99" />
    <meta property="og:published_time" content={pubDate.toISOString()} />
    {
      currentBlog.data.updatedDate && (
        <meta
          property="og:modified_time"
          content={currentBlog.data.updatedDate.toISOString()}
        />
      )
    }
    {tags?.map((tag: string) => <meta property="og:tag" content={tag} />)}

    <meta name="twitter:label1" content="Reading time" />
    <meta name="twitter:data1" content={readTime || "5 min read"} />
    <meta name="twitter:label2" content="Category" />
    <meta name="twitter:data2" content={tags?.[0] || "Technology"} />

    {
      canonicalUrl ? (
        <link rel="canonical" href={canonicalUrl} />
      ) : (
        <link rel="canonical" href={pageUrl} />
      )
    }

    <meta name="language" content="English" />
    <meta name="geo.region" content="US" />
    <meta name="geo.placename" content="United States" />

    <meta
      http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests"
    />

    <script
      is:inline
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2480387803052595"
      crossorigin="anonymous"></script>
  </head>
  <body class="blog-container" style="overflow-x: hidden; overflow-y: auto;">
    <Header />

    <main class="main-content relative z-10 flex flex-1 flex-col">
      <section class="post-shell">
        <header class="post-header">
          <div class="post-eyebrow">
            <time datetime={pubDate.toISOString()}>
              {
                new Date(pubDate).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })
              }
            </time>
            {
              isArchive && (
                <span class="post-badge">
                  Archived article &middot; may be outdated
                </span>
              )
            }
          </div>

          <h1
            class="post-title bg-gradient-to-r from-[#7aa2f7] via-[#bb9af7] to-[#9ece6a] bg-clip-text text-transparent"
          >
            {title}
          </h1>

          {lead && <p class="post-lead">{lead}</p>}

          <div class="post-byline">
            <div class="post-author">
              {
                authorAvatar ? (
                  <img
                    src={authorAvatar}
                    alt=""
                    aria-hidden="true"
                    class="inline-block h-8 w-8 rounded-full border border-[#565f89]/30 object-cover"
                    loading="eager"
                  />
                ) : (
                  <div class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-[#24283b] text-xs font-medium text-[#7aa2f7] ring-1 ring-[#565f89]/30">
                    {authorName?.charAt(0)?.toUpperCase()}
                  </div>
                )
              }
              <span>{authorName}</span>
            </div>
            {readTime && <span>{readTime}</span>}
            {
              currentBlog.data.updatedDate && (
                <span>
                  Updated{" "}
                  {currentBlog.data.updatedDate.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })}
                </span>
              )
            }
          </div>

          {
            tags && tags.length > 0 && (
              <div class="post-tags">
                {tags.map((tag: string) => (
                  <span class="post-tag">{tag}</span>
                ))}
              </div>
            )
          }
        </header>

        <div class="post-grid">
          <aside class="post-rail post-rail--left">
            <div class="post-card">
              <div class="post-card-title">Reading</div>
              <div class="post-stat">
                <span>Reading time</span>
                <strong>{readTime || "5 min read"}</strong>
              </div>
              {
                wordCount > 0 && (
                  <div class="post-stat">
                    <span>Word count</span>
                    <strong>{formattedWordCount}</strong>
                  </div>
                )
              }
              <div class="post-progress">
                <div
                  class="post-progress-track"
                  role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-valuenow="0"
                  data-read-progress-track
                >
                  <div class="post-progress-fill" data-read-progress-fill></div>
                </div>
                <span class="post-progress-label" data-read-progress-label>
                  0%
                </span>
              </div>
            </div>

            <div class="post-card">
              <div class="post-card-title">Quick actions</div>
              <div class="post-actions">
                <div class="post-action-menu" data-post-action-menu>
                  <div class="post-action-split">
                    <button
                      class="post-action-main"
                      type="button"
                      data-copy-page-primary
                    >
                      <Icon
                        name="lucide:copy"
                        class="post-action-main-icon"
                        aria-hidden="true"
                      />
                      <span class="post-action-main-label">Copy page</span>
                      <span class="post-action-main-loader" aria-hidden="true"
                      ></span>
                    </button>
                    <button
                      class="post-action-toggle"
                      type="button"
                      aria-haspopup="menu"
                      aria-expanded="false"
                      aria-controls="post-markdown-actions"
                      data-post-action-toggle
                    >
                      <span class="post-action-chevron" aria-hidden="true">
                        ▾
                      </span>
                    </button>
                  </div>
                  <div
                    class="post-action-dropdown"
                    id="post-markdown-actions"
                    role="menu"
                    aria-label="Copy page actions"
                    data-post-action-dropdown
                    hidden
                  >
                    <button
                      class="post-action-option"
                      type="button"
                      role="menuitem"
                      data-open-markdown
                    >
                      <Icon
                        name="lucide:external-link"
                        class="post-action-option-icon"
                        aria-hidden="true"
                      />
                      <span class="post-action-option-label">Open Markdown</span
                      >
                      <span class="post-action-option-loader" aria-hidden="true"
                      ></span>
                    </button>
                    <button
                      class="post-action-option"
                      type="button"
                      role="menuitem"
                      data-ask-chatgpt
                    >
                      <Icon
                        name="lucide:sparkles"
                        class="post-action-option-icon"
                        aria-hidden="true"
                      />
                      <span class="post-action-option-label">
                        Ask ChatGPT
                      </span>
                      <span class="post-action-option-loader" aria-hidden="true"
                      ></span>
                    </button>
                  </div>
                </div>
                <div class="post-actions-share" aria-label="Share on social">
                  <ShareButtons
                    url={pageUrl}
                    pagetitle="Article"
                    client:visible
                    compact={true}
                  />
                </div>
              </div>
              <span
                class="post-action-status"
                data-copy-status
                aria-live="polite"></span>
            </div>
          </aside>

          <article class="post-content prose blog-prose" id="post-content">
            <slot />
          </article>

          <aside class="post-rail post-rail--right">
            <div class="post-card">
              <div class="post-card-title">On this page</div>
              <nav class="post-toc" id="post-toc" aria-label="On this page">
                {
                  tocEntries.length > 0 ? (
                    tocEntries.map((h: import("astro").MarkdownHeading) => (
                      <a
                        class={h.depth === 3 ? "toc-link toc-h3" : "toc-link"}
                        href={`#${h.slug}`}
                      >
                        {h.text}
                      </a>
                    ))
                  ) : (
                    <span class="post-toc-empty" data-toc-empty>
                      No sections yet
                    </span>
                  )
                }
              </nav>
            </div>
            {
              !isArchive && (
                <div class="post-card">
                  <section
                    class="ads-section ads-section--rail"
                    aria-label="Ads"
                  >
                    <h2 class="ads-section-title">Ads</h2>
                    <div id="blog-ads" class="ads-slot">
                      <ins
                        class="adsbygoogle"
                        style="display:inline-block;width:336px;height:280px"
                        data-ad-client="ca-pub-2480387803052595"
                        data-ad-slot="3981831087"
                      />
                      <script is:inline>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                      </script>
                    </div>
                  </section>
                </div>
              )
            }
          </aside>
        </div>
      </section>

      {
        !isArchive ? (
          <>
            <MermaidRenderer client:load />

            <EnhancedImageCaptionRenderer client:load />

            <CodeCopySimple client:load />

            <BlogNavigation
              client:load
              currentSlug={currentSlug || ""}
              allPosts={BlogPosts}
              basePath="/blog"
            />

            <div class="comments-section">
              <div class="border-t border-[#565f89]/10 pt-8">
                <h2 class="mb-1 text-sm font-medium tracking-wide text-[#565f89] uppercase">
                  Discussion
                </h2>
                <p class="mb-6 text-xs text-[#414868]">
                  Share your thoughts and engage with the community
                </p>
                <div class="relative">
                  <PostComment />
                </div>
              </div>
            </div>
          </>
        ) : (
          <div class="mx-auto mt-10 flex w-full max-w-4xl items-center justify-between border-t border-[#565f89]/20 px-6 py-8">
            {prevPost ? (
              <a
                href={`/blog/archive/${prevPost.slug}`}
                class="group flex max-w-xs items-center gap-3 text-left"
              >
                <div class="flex flex-col">
                  <span class="text-xs font-medium uppercase tracking-wide text-[#565f89]">
                    Previous
                  </span>
                  <span class="line-clamp-2 text-sm text-[#a9b1d6] transition-colors duration-200 group-hover:text-[#7aa2f7]">
                    {prevPost.data.title}
                  </span>
                </div>
                <svg
                  class="h-4 w-4 flex-shrink-0 text-[#565f89] transition-colors duration-200 group-hover:text-[#7aa2f7]"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </a>
            ) : (
              <div />
            )}

            {nextPost ? (
              <a
                href={`/blog/archive/${nextPost.slug}`}
                class="group flex max-w-xs items-center gap-3 text-right"
              >
                <svg
                  class="h-4 w-4 flex-shrink-0 text-[#565f89] transition-colors duration-200 group-hover:text-[#7aa2f7]"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
                <div class="flex flex-col">
                  <span class="text-xs font-medium uppercase tracking-wide text-[#565f89]">
                    Next
                  </span>
                  <span class="line-clamp-2 text-sm text-[#a9b1d6] transition-colors duration-200 group-hover:text-[#7aa2f7]">
                    {nextPost.data.title}
                  </span>
                </div>
              </a>
            ) : (
              <div />
            )}
          </div>
        )
      }
    </main>

    <script
      is:inline
      id="post-action-data"
      type="application/json"
      set:html={postActionPayload}
    />

    <script is:inline>
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }

      function initBlogPost() {
        window.scrollTo(0, 0);

        const progressLabel = document.querySelector(
          "[data-read-progress-label]",
        );
        const progressFill = document.querySelector(
          "[data-read-progress-fill]",
        );
        const progressTrack = document.querySelector(
          "[data-read-progress-track]",
        );
        const copyStatus = document.querySelector("[data-copy-status]");
        const actionMenu = document.querySelector("[data-post-action-menu]");
        const copyPagePrimaryBtn = document.querySelector(
          "[data-copy-page-primary]",
        );
        const actionMenuToggle = document.querySelector(
          "[data-post-action-toggle]",
        );
        const actionMenuDropdown = document.querySelector(
          "[data-post-action-dropdown]",
        );
        const openMarkdownBtn = document.querySelector("[data-open-markdown]");
        const askChatGptBtn = document.querySelector("[data-ask-chatgpt]");
        const postActionData = document.getElementById("post-action-data");
        const tocRoot = document.getElementById("post-toc");
        const tocEmpty = tocRoot?.querySelector("[data-toc-empty]") || null;
        const postContent = document.getElementById("post-content");
        const wait = (durationMs) =>
          new Promise((resolve) => window.setTimeout(resolve, durationMs));
        const postActionDataRaw = postActionData?.textContent || "{}";
        let postActionMeta = {
          title: document.title,
          url: window.location.href,
          markdown: "",
        };
        try {
          postActionMeta = {
            ...postActionMeta,
            ...JSON.parse(postActionDataRaw),
          };
        } catch (error) {
          postActionMeta = { ...postActionMeta };
        }

        const markdownText =
          postActionMeta.markdown ||
          `# ${postActionMeta.title}\n\nSource: ${postActionMeta.url}\n`;
        const chatPrompt = [
          "Analyze this blog post and help me understand it.",
          "Share: 1) concise summary, 2) key takeaways, 3) practical suggestions.",
          "",
          `Title: ${postActionMeta.title}`,
          `URL: ${postActionMeta.url}`,
          "",
          "Markdown:",
          markdownText,
        ].join("\n");

        let statusTimer = 0;
        const setStatus = (message, delay = 2200) => {
          if (!copyStatus) return;
          copyStatus.textContent = message;
          if (statusTimer) {
            clearTimeout(statusTimer);
          }
          if (!message || delay <= 0) return;
          statusTimer = window.setTimeout(() => {
            copyStatus.textContent = "";
          }, delay);
        };

        const runOptionAction = async (button, action) => {
          if (!button || button.getAttribute("data-loading") === "true") {
            return false;
          }

          button.setAttribute("data-loading", "true");
          button.setAttribute("aria-busy", "true");
          button.classList.add("is-loading");

          let succeeded = false;
          const startedAt = performance.now();

          try {
            await action();
            succeeded = true;
          } catch (error) {
            succeeded = false;
          }

          const elapsed = performance.now() - startedAt;
          if (elapsed < 320) {
            await wait(320 - elapsed);
          }

          button.classList.remove("is-loading");
          button.removeAttribute("data-loading");
          button.removeAttribute("aria-busy");

          if (succeeded) {
            button.classList.add("is-success");
            window.setTimeout(() => {
              button.classList.remove("is-success");
            }, 650);
          }

          return succeeded;
        };

        const openActionMenu = () => {
          if (!actionMenu || !actionMenuDropdown || !actionMenuToggle) return;
          actionMenu.classList.add("is-open");
          actionMenuDropdown.hidden = false;
          actionMenuToggle.setAttribute("aria-expanded", "true");
        };

        const closeActionMenu = () => {
          if (!actionMenu || !actionMenuDropdown || !actionMenuToggle) return;
          actionMenu.classList.remove("is-open");
          actionMenuDropdown.hidden = true;
          actionMenuToggle.setAttribute("aria-expanded", "false");
        };

        const setActive = (id) => {
          (tocRoot?.querySelectorAll("a") || []).forEach((link) => {
            link.classList.toggle(
              "is-active",
              link.getAttribute("href") === `#${id}`,
            );
          });
        };

        const slugCounts = new Map();
        const slugify = (text) => {
          const base = text
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9\s-]/g, "")
            .replace(/\s+/g, "-")
            .replace(/-+/g, "-");
          const count = slugCounts.get(base) || 0;
          slugCounts.set(base, count + 1);
          return count ? `${base}-${count + 1}` : base;
        };

        const buildToc = () => {
          const headings = Array.from(
            postContent
              ? postContent.querySelectorAll("h2, h3")
              : document.querySelectorAll(".blog-prose h2, .blog-prose h3"),
          );

          if (!tocRoot) return headings;

          tocRoot.innerHTML = "";
          if (headings.length === 0) {
            if (tocEmpty) {
              tocRoot.appendChild(tocEmpty);
            }
          } else {
            headings.forEach((heading) => {
              if (!heading.id) {
                heading.id = slugify(heading.textContent || "section");
              }
              const link = document.createElement("a");
              link.href = `#${heading.id}`;
              link.textContent = heading.textContent || heading.id;
              link.className =
                heading.tagName === "H3" ? "toc-link toc-h3" : "toc-link";
              tocRoot.appendChild(link);
            });
          }
          return headings;
        };

        const hasServerToc =
          tocRoot && tocRoot.querySelectorAll("a.toc-link").length > 0;
        const headings = hasServerToc
          ? Array.from(tocRoot.querySelectorAll("a.toc-link"))
              .map((a) => {
                const slug = (a.getAttribute("href") || "").replace(/^#/, "");
                return document.getElementById(slug);
              })
              .filter(Boolean)
          : buildToc();

        if (!hasServerToc && headings.length === 0 && postContent) {
          requestAnimationFrame(() => {
            const retryHeadings = buildToc();
            if (retryHeadings.length > 0 && "IntersectionObserver" in window) {
              const observer = new IntersectionObserver(
                (entries) => {
                  entries.forEach((entry) => {
                    if (entry.isIntersecting && entry.target.id) {
                      setActive(entry.target.id);
                    }
                  });
                },
                { rootMargin: "0px 0px -65% 0px" },
              );
              retryHeadings.forEach((h) => observer.observe(h));
            }
          });
        }

        if (headings.length > 0 && "IntersectionObserver" in window) {
          const observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting && entry.target.id) {
                  setActive(entry.target.id);
                }
              });
            },
            { rootMargin: "0px 0px -65% 0px" },
          );
          headings.forEach((heading) => observer.observe(heading));
        }

        let rafId = 0;
        const updateProgress = () => {
          rafId = 0;
          const totalHeight = document.body.scrollHeight - window.innerHeight;
          const scrollTop =
            window.scrollY || document.documentElement.scrollTop;
          const progress =
            totalHeight > 0
              ? Math.min(Math.max(scrollTop / totalHeight, 0), 1)
              : 0;

          if (progressFill) {
            progressFill.style.transform = `scaleX(${progress})`;
          }
          if (progressLabel) {
            progressLabel.textContent = `${Math.round(progress * 100)}%`;
          }
          if (progressTrack) {
            progressTrack.setAttribute(
              "aria-valuenow",
              `${Math.round(progress * 100)}`,
            );
          }
        };

        const onScroll = () => {
          if (rafId) return;
          rafId = requestAnimationFrame(updateProgress);
        };

        window.addEventListener("scroll", onScroll, { passive: true });
        updateProgress();

        if (actionMenu && actionMenuToggle) {
          actionMenuToggle.addEventListener("click", () => {
            const isExpanded =
              actionMenuToggle.getAttribute("aria-expanded") === "true";
            if (isExpanded) {
              closeActionMenu();
            } else {
              openActionMenu();
            }
          });

          document.addEventListener("click", (event) => {
            const target = event.target;
            if (!(target instanceof Node)) return;
            if (!actionMenu.contains(target)) {
              closeActionMenu();
            }
          });

          document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
              closeActionMenu();
            }
          });
        }

        if (copyPagePrimaryBtn) {
          copyPagePrimaryBtn.addEventListener("click", async () => {
            const didCopy = await runOptionAction(
              copyPagePrimaryBtn,
              async () => {
                await navigator.clipboard.writeText(markdownText);
                setStatus("Page copied as Markdown");
              },
            );

            if (!didCopy) {
              setStatus("Copy failed");
            }
          });
        }

        if (openMarkdownBtn) {
          openMarkdownBtn.addEventListener("click", async () => {
            const openedMarkdown = await runOptionAction(
              openMarkdownBtn,
              async () => {
                const markdownBlob = new Blob([markdownText], {
                  type: "text/markdown;charset=utf-8",
                });
                const markdownUrl = URL.createObjectURL(markdownBlob);
                const markdownTab = window.open(
                  markdownUrl,
                  "_blank",
                  "noopener,noreferrer",
                );

                window.setTimeout(
                  () => URL.revokeObjectURL(markdownUrl),
                  20000,
                );

                if (!markdownTab) {
                  throw new Error("popup-blocked");
                }

                setStatus("Opened markdown in a new tab");
              },
            );

            if (!openedMarkdown) {
              setStatus("Popup blocked while opening markdown");
            }

            closeActionMenu();
          });
        }

        if (askChatGptBtn) {
          askChatGptBtn.addEventListener("click", async () => {
            const openedChat = await runOptionAction(
              askChatGptBtn,
              async () => {
                try {
                  await navigator.clipboard.writeText(chatPrompt);
                  setStatus("Prompt copied. Opening ChatGPT...");
                } catch (error) {
                  setStatus("Opening ChatGPT (clipboard blocked)");
                }

                const chatWindow = window.open(
                  `https://chatgpt.com/?q=${encodeURIComponent(
                    `Help me with this blog post: ${postActionMeta.title} ${postActionMeta.url}`,
                  )}`,
                  "_blank",
                  "noopener,noreferrer",
                );

                if (!chatWindow) {
                  throw new Error("popup-blocked");
                }
              },
            );

            if (!openedChat) {
              setStatus("Popup blocked while opening ChatGPT");
            }

            closeActionMenu();
          });
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initBlogPost);
      } else {
        initBlogPost();
      }
      document.addEventListener("astro:after-swap", initBlogPost);
    </script>
    <Footer />
  </body>
</html>
